ToolBox

# 实现目标(客户端)

- [ ] 番茄工作法
- [ ] 时钟
- [ ] 翻译接口

# 实现目标(服务端)

- [x] **密码加密保存**
- [x] **备忘录**
- [x] 登录认证
- [x] **邮箱注册**
- [x] 打卡
- [ ] 时间表（难点在于客户端）

# 技术选择

- 后端
  - golang
  - gin
  - xorm

# 数据库选择

- mysql

  基础服务

- redis

  邮箱注册

  排行榜

  备忘录（hash）
  
  

# 技术难点

## 注册时验证身份

​	在这个项目中身份验证采用邮箱验证，生成验证码后保存于redis，并**设置过期时间**。过期时间能在一定程度上保证验证码的安全性。在提交注册表单时需要携带注册邮箱的验证码。使用`github.com/jordan-wright/email`库进行发送邮件。

## 跨域访问

​	使用中间件修改报头，在每次请求是添加上 `Access-Control-Allow-Origin` 头部

~~~ go
func Cors() gin.HandlerFunc {
	c := conf.GetConf()
	return func(context *gin.Context) {
		method := context.Request.Method
		context.Header("Access-Control-Allow-Origin", c.DomainName) // 设置允许访问所有域
		context.Header("Access-Control-Allow-Methods", "POST, GET, OPTIONS, PUT, DELETE,UPDATE")
		context.Header("Access-Control-Allow-Headers", "Authorization, Content-Length, X-CSRF-Token, Token,session,X_Requested_With,Accept, Origin, Host, Connection, Accept-Encoding, Accept-Language,DNT, X-CustomHeader, Keep-Alive, User-Agent, X-Requested-With, If-Modified-Since, Cache-Control, Content-Type, Pragma,token,openid,opentoken")
		context.Header("Access-Control-Expose-Headers", "Content-Length, Access-Control-Allow-Origin, Access-Control-Allow-Headers,Cache-Control,Content-Language,Content-Type,Expires,Last-Modified,Pragma,FooBar")
		context.Header("Access-Control-Max-Age", "172800")
		context.Header("Access-Control-Allow-Credentials", "true")
		context.Set("content-type", "application/json")
		// 前端向后端发送的OPTIONS测试请求 服务器只需回应200
		if method == "OPTIONS" {
			context.JSON(http.StatusOK, response.OK)
		}

		//处理请求
		context.Next()
	}
}
~~~

​	并在注册路由前使用中间件

~~~ go
// 使用中间件配置跨域
r.Use(middleware.Cors())
~~~

##  身份验证

​	使用中间件在报文中读取`Authorization`信息并进行验证。

需要注意：

* 项目中的密文统一使用`Bearer `开头，在解密时需要注意删除前7位(包含空格)

~~~ go
func ParseToken(tokenString string) (*jwt.Token, *Claims, error) {
	claims := &Claims{}

	token, err := jwt.ParseWithClaims(tokenString, claims, func(token *jwt.Token) (i interface{}, err error) {
		return jwtKey, nil
	})

	return token, claims, err
}
~~~



​	将翻译出来的claims中包含的**user信息**与数据库中的信息进行对比。

在需要进行身份的路由上直接调用中间件即可进行身份验证

~~~ go

// 修改余额信息
r.PUT(userApiURI+"/pay", middleware.AuthMiddleWare(), api.UserChangePay)
~~~

## 密码加密解密

​	考虑到密码的重要性，加密时使用**RSA加密算法**，在注册用户时返回私钥，由服务器的Redis保存公钥用于加密。

## 定时任务

## Redis持久化



# 数据库设计

* 用户

| 字段名   | 含义              | 类型    |
| -------- | ----------------- | ------- |
| id       | id                | key     |
| password | 密码              | varchar |
| account  | 账号 使用邮箱注册 | varchar |
| avatar   | 头像编号          | int     |
| name     | 昵称              | varchar |

* 备忘录

| 字段名   | 含义               | 类型    |
| -------- | ------------------ | ------- |
| id       | id                 | key     |
| info     | 备忘录中存储的信息 | varchar |
| owner    | 拥有者             | bigint  |
| status   | 状态               | int     |
| end_time | 截止时间           | bigint  |

* 密码

| 字段名 | 含义             | 类型   |
| ------ | ---------------- | ------ |
| id     | id               | key    |
| use    | 这段密码由于什么 | string |
| owner  | 密码所属用户账号 | string |
| info   | 加密后的密码     | text   |

* 打卡

| 字段名         | 含义         | 类型    |
| -------------- | ------------ | ------- |
| id             | id           | key     |
| owner          | 拥有者       | varchar |
| kind           | 打卡种类     | int     |
| start          | 开始时间     | int     |
| achieve_target | 打卡目标次数 | int     |
| achieve_now    | 已经实现次数 | int     |
| interval       | 打卡周期     | int     |
| status         | 打卡类型     | int     |






# 接口开发进度

| 接口路径                | 请求方式 | 功能                 |
| ----------------------- | -------- | -------------------- |
| /api/user/mail          | POST     | 请求发送邮箱验证码   |
| /api/user               | POST     | 注册用户             |
| /api/user/login         | POST     | 登录                 |
| /api/memo               | GET      | 根据拥有者查询备忘录 |
| /api/memo/:id           | DELETE   | 删除备忘录           |
| /api/memo               | POST     | 上传备忘录           |
| /api/memo               | PUT      | 更新备忘录           |
| /api/cipher             | POST     | 保存密码             |
| /api/cipher             | GET      | 获取密码             |
| /api/cipher/translation | POST     | 翻译密码             |
| /api/clock              | POST     | 上传打卡             |
| /api/clock/:id          | PUT      | 打卡                 |
| /api/clock/:id          | DELETE   | 删除打卡             |



# Api Service Dao 之间的调用关系

| Api                | Service                    | Dao                  |
| ------------------ | -------------------------- | -------------------- |
| UserRegister       | UserEmailVerifyCodeService | UserIsExst           |
| ---                | ---                        | UserEmailCodeGet     |
| ---                | UserAddService             | UserInsert           |
| ---                | ---                        | CipherSet            |
| UserEmailVerify    | UserEmailVerifyService     | UserIsExist          |
| ---                | ---                        | UserEmailRedisSave   |
| UserLogin          | UserLoginService           | UserIsExist          |
| ---                | ---                        | UserLogin            |
| MemoQueryByOwner   | MemoQueryByOwnerService    | MemoFindByOwner      |
| MemoUpload         | MemoAdd                    | MemoInsert           |
| MemoDelete         | MemoDelete                 | MemoDelete           |
| MemoUpdate         | MemoPut                    | MemoUpdate           |
| CipherUpload       | CipherAdd                  | CipherRedisGet       |
| ---                | ---                        | CipherInsert         |
| CipherQueryByOwner | CipherQueryByOwnerService  | CipherFindByOwner    |
| CipherTranslate    | CipherTranslate            | CipherFindById       |
| CipherUpload       | CipherAdd                  | CipherRedisGet       |
| ---                | ---                        | CipherInsert         |
| ClockUpload        | ClockUpload                | ClockUpload          |
| ClockQueryByOwner  | ClockQueryByOwner          | ClockQueryByOwner    |
| ClockIn            | ClockClockIn               | ClockGetAchieveNow   |
| ---                | ---                        | ClockIsGonnaFinished |
| ---                | ---                        | ClockUpdate          |
| ClockDelete        | ClockClockDelete           | ClockGetAchieveNow   |
| ---                | ---                        | ClockDelete          |







# 开发日记

* 2022年10月19日 
  * 后端部分初始化
* 2022年10月20日
  * 初始化User表
  * 使用xorm实现新增用户dao
  * 添加md5加密
* 2022年10月21日
  * 添加redis模块
  * 生成验证码
  * 通过邮箱发送验证码
  * 通过邮箱注册
* 2022年10月22日
  * 登陆验证
  * 登录并返回token
  * 配置文件类型更换为ini
* 2022年10月23日
  * 写作业 摸了
* 2022年10月24日
  * 创建Memo表
  * 通过owner查询memo
  * 使用中间件获取用户id和账号
* 2022年10月25日
  * 添加memo
  * 删除memo
  * 更新memo
* 2022年10月26日
  * 摸了
* 2022年10月27日
  * RSA加密实现
  * base64编码后保存到redis
* 2022年10月28日
  * 摸了
* 2022年10月29日
  * 注册时服务器保存公钥并返回私钥
  * 保存密码
  * 根据登录信息查找cipher
  * 解密密码
* 2022年10月30日
  * 创建Clock表
  * 新增Clock
  * 查询clock
  * 打卡
* 2022年10月31日
  * 删除打卡
  * 序列化反序列化测试
  * 初始化web端
* 课设
* 2022年11月5日
  * website登录页面
* 2022年11月7日
  * website注册
  * website导航
  * panel框架
* 2022年11月9日
  * 编辑日程

* 2023年3月19日
  * 新增消费记录
  * 查询一个月的消费记录